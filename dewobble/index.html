<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=9" />
    <meta name="generator" content="Doxygen 1.9.1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dewobble: Dewobble</title>
    <link href="tabs.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
     <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
    <link href="doxygen.css" rel="stylesheet" type="text/css" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="favicon-16x16.png"
    />
    <link rel="manifest" href=site.webmanifest" />
    <link
      rel="mask-icon"
      href="safari-pinned-tab.svg"
      color="#5bbad5"
    />
    <meta name="msapplication-TileColor" content="#b91d47" />
    <meta name="theme-color" content="#ffffff" />
  </head>
  <body>
    <div id="top">
      <!-- do not remove this div, it is closed by doxygen! -->
      <div id="titlearea">
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr style="height: 56px">
              <td id="projectlogo">
                <img alt="Logo" src="apple-touch-icon.png" height="96px" />
              </td>
              <td id="projectalign" style="padding-left: 0.5em">
                <div id="projectname">
                  Dewobble
                </div>
                <div id="projectbrief">Video motion stabilization with awareness of lens      projection</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <!-- end header part -->
    </div>
  </body>
</html>
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Dewobble </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_README"></a> Dewobble is a library for video motion stabilization and camera projection changes. It is written in C++, with headers provided for C++ and C.</p>
<p>It is named dewobble because its accurate camera models avoid the wobbling effect that is produced by many other video stabilisation libraries when they are applied to videos with a wide field of view.</p>
<p><img src="https://git.sr.ht/~hedgepigdaniel/dewobble/blob/trunk/logo.png" alt="" width="320px" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md1"></a>
Documentation</h1>
<p>See the detailed Doxygen <a href="https://www.danielplayfaircal.com/dewobble/index.html">documentation</a>.</p>
<h1><a class="anchor" id="autotoc_md2"></a>
Code</h1>
<p>See the <a href="https://git.sr.ht/~hedgepigdaniel/dewobble">repository</a> on Sourcehut.</p>
<h1><a class="anchor" id="autotoc_md3"></a>
Features</h1>
<ul>
<li>Accurate motion detection and wobble free output due to accurate camera models</li>
<li>Option to choose a different camera projection for the output</li>
<li>Single pass of pixel interpolation to perform both projection change and motion stabilisation</li>
<li>Choice of pixel interpolation algorithms including bilinear, cubic, and lanczos4</li>
<li>Options for simulating a fixed camera position or to skip stabilization and only change projection</li>
<li>Fast processing with the majority of work done in OpenCL</li>
<li>Adjust output dimensions and focal length to include as much or as little of the input as you want</li>
<li>Robust motion estimation even in relatively blurry or low contrast images</li>
<li>Interpolation of camera motion if detection fails for some frames</li>
</ul>
<h1><a class="anchor" id="autotoc_md4"></a>
Performance</h1>
<p>The majority of processing (with some exceptions, depending on settings) is done using OpenCL. Depending on the OpenCL implementation, this gives great performance with minimal CPU load. On weaker integrated graphics the process is usually GPU bound, whereas on discrete GPUs it tends to be CPU bound.</p>
<h2><a class="anchor" id="autotoc_md5"></a>
Benchmark</h2>
<table class="doxtable">
<tr>
<th>Hardware and OpenCL implementation </th><th>1920x1440, default settings </th><th>1920x1440, no stabilization  </th></tr>
<tr>
<td>Intel i7-8750H (Core/Xeon runtime) </td><td>22fps </td><td>42fps  </td></tr>
<tr>
<td>Intel UHD Graphics 630 (intel-compute-runtime) + i7-8750H </td><td>51fps </td><td>94fps  </td></tr>
<tr>
<td>Nvidia GTX 1050 Ti mobile (proprietary driver) + i7-8750H </td><td>88fps </td><td>374fps  </td></tr>
<tr>
<td>AMD Radeon RX 5600XT (ROCm or AMDGPU-PRO) + i3-8100 </td><td>61fps </td><td>165fps  </td></tr>
</table>
<p>These benchmarks are collected by using the in development <code>dewobble_opencl</code> FFmpeg filter. For GPUs other than Intel (which has a zero copy VA-API to OpenCL interop), the times include copying the video frames from the GPU (where the input video is decoded) to the CPU, and then back to the GPU again for the filter.</p>
<p>The first test is for the default settings including stabilization, and the second for projection change only (which happens entirely in OpenCL).</p>
<h1><a class="anchor" id="autotoc_md6"></a>
Requirements</h1>
<h2><a class="anchor" id="autotoc_md7"></a>
Build</h2>
<ul>
<li><a href="https://github.com/KhronosGroup/OpenCL-Headers">C OpenCL headers</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md8"></a>
Build and run</h2>
<ul>
<li><a href="https://opencv.org/">OpenCV</a> - used extensively, especially for feature detection and tracking and homography estimation.</li>
<li><a href="https://github.com/arntanguy/gram_savitzky_golay">gram_savitzky_golay</a> - used for camera path optimisation</li>
</ul>
<h2><a class="anchor" id="autotoc_md9"></a>
Run</h2>
<ul>
<li>A working implementation of OpenCL</li>
</ul>
<h1><a class="anchor" id="autotoc_md10"></a>
Usage</h1>
<h2><a class="anchor" id="autotoc_md11"></a>
C++</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;dewobble/filter_threaded.hpp&gt;</span></div>
<div class="line"> </div>
<div class="line"><a class="code" href="classdewobble_1_1Camera.html">dewobble::Camera</a> input_camera(</div>
<div class="line">    PROJECTION_EQUIDISTANT_FISHEYE,</div>
<div class="line">    145.8 1920,</div>
<div class="line">    1440,</div>
<div class="line">    (1920 - 1.0) / 2,</div>
<div class="line">    (1440 - 1.0) / 2);</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classdewobble_1_1Camera.html">dewobble::Camera</a> output_camera(</div>
<div class="line">    PROJECTION_RECTILINEAR,</div>
<div class="line">    145.8 1920,</div>
<div class="line">    1440,</div>
<div class="line">    (1920 - 1.0) / 2,</div>
<div class="line">    (1440 - 1.0) / 2);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">auto</span> stabilizer =</div>
<div class="line">    make_shared&lt;dewobble::StabilizerSavitzkyGolay&gt;(input_camera, 60, 30);</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classdewobble_1_1FilterConfig.html">dewobble::FilterConfig</a> config(input_camera, output_camera, stabilizer);</div>
<div class="line">config.set_opencl_context(context);</div>
<div class="line">congif.set_opencl_device(device);</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classdewobble_1_1FilterThreaded.html">dewobble::FilterThreaded</a> filter(input_camera, output_camera, stabilizer);</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">while</span> (...) {</div>
<div class="line">    cl_mem input_frame = filter.get_input_frame_buffer();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ... put data in input frame</span></div>
<div class="line"> </div>
<div class="line">    filter.push_frame(input_frame);</div>
<div class="line">}</div>
<div class="line">filter.end_input();</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">while</span> (filter.frame_ready()) {</div>
<div class="line">    cl_mem output_frame = NULL, input_frame;</div>
<div class="line">    filter.pull_frame(&amp;output_frame, &amp;input_frame, NULL);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ... retrieve data from output frame</span></div>
<div class="line"> </div>
<div class="line">    filter.release_input_frame_buffer(&amp;input_frame);</div>
<div class="line">    filter.release_output_frame_buffer(&amp;output_frame);</div>
<div class="line">}</div>
<div class="ttc" id="aclassdewobble_1_1Camera_html"><div class="ttname"><a href="classdewobble_1_1Camera.html">dewobble::Camera</a></div><div class="ttdef"><b>Definition:</b> camera.hpp:15</div></div>
<div class="ttc" id="aclassdewobble_1_1FilterConfig_html"><div class="ttname"><a href="classdewobble_1_1FilterConfig.html">dewobble::FilterConfig</a></div><div class="ttdef"><b>Definition:</b> filter_config.hpp:34</div></div>
<div class="ttc" id="aclassdewobble_1_1FilterThreaded_html"><div class="ttname"><a href="classdewobble_1_1FilterThreaded.html">dewobble::FilterThreaded</a></div><div class="ttdef"><b>Definition:</b> filter_threaded.hpp:81</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md12"></a>
C</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;dewobble/filter_threaded.h&gt;</span></div>
<div class="line"> </div>
<div class="line">DewobbleCamera input_camera = NULL, output_camera = NULL;</div>
<div class="line">DewobbleStabilizer stabilizer = NULL;</div>
<div class="line">DewobbleFilterConfig config = NULL;</div>
<div class="line">DewobbleFilter filter = NULL;</div>
<div class="line"> </div>
<div class="line">input_camera = dewobble_camera_create(</div>
<div class="line">    DEWOBBLE_PROJECTION_EQUIDISTANT_FISHEYE,</div>
<div class="line">    145.8 * PI / 180,</div>
<div class="line">    1920,</div>
<div class="line">    1440,</div>
<div class="line">    (1920 - 1.0) / 2,</div>
<div class="line">    (1440 - 1.0) / 2);</div>
<div class="line"> </div>
<div class="line">output_camera = dewobble_camera_create(</div>
<div class="line">    DEWOBBLE_PROJECTION_RECTILINEAR,</div>
<div class="line">    145.8 * PI / 180,</div>
<div class="line">    1920,</div>
<div class="line">    1440,</div>
<div class="line">    (1920 - 1.0) / 2,</div>
<div class="line">    (1440 - 1.0) / 2);</div>
<div class="line"> </div>
<div class="line">stabilizer = dewobble_stabilizer_create_savitzky_golay(input_camera, 60, 30);</div>
<div class="line"> </div>
<div class="line">config = dewobble_filter_config_create(input_camera, output_camera, stabilizer);</div>
<div class="line">dewobble_filter_config_set_opencl_context(config, context);</div>
<div class="line">dewobble_filter_config_set_opencl_context(config, device);</div>
<div class="line"> </div>
<div class="line">filter = dewobble_filter_create_threaded(config);</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">while</span> (...) {</div>
<div class="line">    cl_mem input_frame = dewobble_filter_get_input_frame_buffer(filter);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ... put data in input frame</span></div>
<div class="line"> </div>
<div class="line">    dewobble_filter_push_frame(filter, input_frame, NULL);</div>
<div class="line">}</div>
<div class="line">dewobble_filter_end_input(filter);</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">while</span> (dewobble_filter_frame_ready(filter)) {</div>
<div class="line">    cl_mem output_frame = NULL, input_frame;</div>
<div class="line">    frame =</div>
<div class="line">        dewobble_filter_pull_frame(filter, &amp;output_frame, &amp;input_frame, NULL);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ... retrieve data from output frame</span></div>
<div class="line"> </div>
<div class="line">    dewobble_filter_release_output_frame_buffer(filter, &amp;output_frame);</div>
<div class="line">    dewobble_filter_release_input_frame_buffer(filter, &amp;input_frame);</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md13"></a>
input/output format</h2>
<p>Currently the only accepted input and output is an OpenCL buffer containing an NV12 image with full range BT.709 colours. To assist with tracking other data associated with frames, it is also possible to attach a <code>void *</code> pointer called <code>extra</code> to each frame.</p>
<h1><a class="anchor" id="autotoc_md14"></a>
Choosing an OpenCL platform</h1>
<p>The filter config class has the ability to configure the OpenCL context and device to used by the filter. By default, the OpenCL platform will be chosen by OpenCV. The configured context and device must match that of the buffers you pass in.</p>
<p><b>Note</b>: OpenCV uses a global/implicit OpenCL context which is local to the current thread. If you use the threaded variant of the filter, all usage of OpenCV will occur in a separate thread, and will therefore not interfere with the use of OpenCV in your application threads. The API is the same, although the threaded variant will keep one extra frame in the pipeline to assist with keeping the worker thread busy.</p>
<h1><a class="anchor" id="autotoc_md15"></a>
Supported camera projection models</h1>
<h2><a class="anchor" id="autotoc_md16"></a>
Rectilinear</h2>
<p>This is the most commonly used camera projection, and has the property that straight lines in the real world appear straight in the image. Dewobble supports rectilinear projections with a configurable field of view and focal point.</p>
<h2><a class="anchor" id="autotoc_md17"></a>
Equidistant fisheye</h2>
<p>This is a popular projection used in very wide angle lenses. If desired it is able to project the entire sphere of potential real world object angles into a circular image. Dewobble supports equidistant fisheye projections with a configurable field of view and focal point.</p>
<h3><a class="anchor" id="autotoc_md18"></a>
Example: GoPro Hero 5 Black</h3>
<table class="doxtable">
<tr>
<th>FoV setting </th><th>Stabilization </th><th>Diagonal FoV  </th></tr>
<tr>
<td>4x3 Wide </td><td>disabled </td><td>145.8&deg;  </td></tr>
<tr>
<td>4x3 Wide </td><td>enabled </td><td>131.5  </td></tr>
<tr>
<td>16x9 Wide </td><td>disabled </td><td>127.9&deg;  </td></tr>
<tr>
<td>16x9 Wide </td><td>enabled </td><td>109.5&deg;  </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md19"></a>
Measuring the camera field of view</h1>
<p>If you don't know the field of view of your camera, you can measure it. In order to work with dewobble, it will need to have a supported type of projection.</p>
<p>Note that the following will affect the measurement:</p><ul>
<li>The lens used.</li>
<li>The zoom level.</li>
<li>Any settings on the camera related to the projection or field of view.</li>
<li>Any built in stabilization on the camera (some cameras apply dynamic zooming/cropping when stabilization is enabled!).</li>
<li>The refractive index of any gas or liquid that the camera is submerged in (e.g. water).</li>
</ul>
<h2><a class="anchor" id="autotoc_md20"></a>
Physical method</h2>
<ol type="1">
<li>Set up the camera at a fixed position facing a wall.</li>
<li>mark the positions on the wall that are shown at two diagonally opposite corners of the image.</li>
<li>Measure the three distances between those points and the camera sensor and use trigonometry (e.g. the cosine rule) to calculate the angle from the camera sensor between the two points. This is the diagonal field of view.</li>
</ol>
<h2><a class="anchor" id="autotoc_md21"></a>
Programmatic method</h2>
<ol type="1">
<li>Compile the OpenCV <a href="https://github.com/hedgepigdaniel/opencv/blob/master/samples/cpp/tutorial_code/calib3d/camera_calibration/camera_calibration.cpp">camera_calibration example</a> and familiarise yourself with its operation.</li>
<li>Configure it to use the fisheye model or not depending on the projection of your camera.</li>
<li>Fix the focal point at the center unless you suspect that your camera is not centered.</li>
<li>Fix the calibration coefficients to 0 (Dewobble does not support these).</li>
<li>Run the calibration.</li>
<li>Read the measured focal length from the <code>&lt;camera_matrix /&gt;</code> element. The horizontal and vertical focal lengths should match closely, and be at position <code>(0, 0)</code> and <code>(1, 1)</code> in the matrix.</li>
<li>Convert this focal length (in pixels) to the diagonal field of view (in radians). For rectilinear projections this is <code>2*atan(sqrt(width^2+height^2)/(2*focal_length))</code>. For fisheye projection this is given by <code>sqrt(width^2+height^2)/focal_length</code>.</li>
</ol>
<h1><a class="anchor" id="autotoc_md22"></a>
Supported camera path smoothing algorithms</h1>
<h2><a class="anchor" id="autotoc_md23"></a>
Savitzky Golay</h2>
<p>Use a Savitzky Golay filter to find a smooth camera path. Adjustable window size (expressed in terms of the number of frames before/after each frame which are considered).</p>
<h2><a class="anchor" id="autotoc_md24"></a>
Fixed</h2>
<p>Fix the camera orientation as it was in the first frame.</p>
<h2><a class="anchor" id="autotoc_md25"></a>
None</h2>
<p>Do not apply motion stabilisation (perform only camera projection changes).</p>
<h1><a class="anchor" id="autotoc_md26"></a>
License</h1>
<p>GPL version 3 or later</p>
<h1><a class="anchor" id="autotoc_md27"></a>
Contributing</h1>
<p>Contributions are welcome and encouraged!</p>
<p>For bug reports, please make a ticket on the issue tracker: <a href="https://todo.sr.ht/~hedgepigdaniel/Dewobble">https://todo.sr.ht/~hedgepigdaniel/Dewobble</a></p>
<p>To send patches, please post to the mailing list: <a href="https://lists.sr.ht/~hedgepigdaniel/dewobble-dev">https://lists.sr.ht/~hedgepigdaniel/dewobble-dev</a></p>
<p>For more complex changes please open a ticket to discuss the idea. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
